<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Muusig Card Game</title>
<style>
  :root{
    --bg:#0f172a; --panel:#111827cc; --text:#e5e7eb; --muted:#9ca3af;
    --accent:#f59e0b; --accent-2:#38bdf8; --danger:#ef4444;
    --card-shadow: 0 10px 24px rgba(0,0,0,.35);
    --glass: blur(8px) saturate(120%); --radius: 14px;
    --deck-img: url('cards/back.png');
    --card-width: 78px;
    --card-height: 117px;
  }
  .theme-light{
    --bg:#f3f4f6; --panel:#ffffffcc; --text:#111827; --muted:#6b7280;
    --accent:#d97706; --accent-2:#0284c7; --danger:#b91c1c;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    background: radial-gradient(1200px 800px at 70% -10%, #1e293b 0%, var(--bg) 60%);
    color: var(--text); margin:0; padding:16px;
  }
  .container{ max-width: 980px; margin:0 auto; }

  /* Welcome */
  .welcome-screen{ position:fixed; inset:0; display:flex; justify-content:center; align-items:center; z-index:1000; background: var(--bg); opacity:1; transition:opacity .6s ease; }
  .welcome-screen.hidden{ opacity:0; pointer-events:none; }
  .welcome-card{
    background:#0f172a; border:1px solid rgba(255,255,255,.12); border-radius:22px; padding:36px 32px;
    width:min(760px,92%); text-align:center; box-shadow: 0 16px 40px rgba(0,0,0,.45);
  }
  .theme-light .welcome-card{ background:#ffffff; border-color: rgba(17,24,39,.12); }
  .welcome-card h1{ margin:0 0 8px; font-size:40px; letter-spacing:.4px }
  .welcome-card .sub{ margin:0 0 18px; font-size:16px; color:var(--muted) }
  .card-preview{ display:flex; justify-content:center; gap:20px; margin:14px 0 26px }
  .preview-card{ width:86px; height:130px; border-radius:12px; background-size:contain; background-repeat:no-repeat; box-shadow: 0 10px 22px rgba(0,0,0,.35); transform:rotate(-1.5deg); transition:.28s; }
  .preview-card:nth-child(2){ transform:rotate(1.2deg) }
  .preview-card:nth-child(3){ transform:rotate(-2.4deg) }
  .preview-card:nth-child(4){ transform:rotate(.8deg) }
  .preview-card:hover{ transform:translateY(-6px) scale(1.03) }
  .welcome-card .btn{ appearance:none;border:0;cursor:pointer; padding:12px 22px; font-size:16px; border-radius:14px; font-weight:700; color:#0b1220; background: linear-gradient(180deg, #ffe08a, #f59e0b); box-shadow: 0 12px 28px rgba(245,158,11,.35); }
  .welcome-card .btn:hover{ filter:brightness(1.04) }
  body.showing-welcome .hud, body.showing-welcome .board { display:none; }

  /* HUD */
  .hud{display:flex;align-items:center;justify-content:space-between; gap:10px;margin:0 auto 12px; width:min(980px,100%)}
  /* Player score (left) and Bot score (in .right) stay on the first row */
  .hud .score{ font-weight: 700; }
  .hud .score small{ font-size: 13px; }
  .hud .score span{ font-size: 18px; }

  /* Round • Trick badge sits centered and can break line */
  .hud > .badge:nth-child(2){
    flex: 0 1 100%;
    text-align: center;
    justify-content: center;
    display: inline-flex;
    gap: 6px;
    order: 2;              /* move to second row for balance */
  }

  /* The right cluster (bot score + switches) stays tidy */
  .right{
    display: inline-flex;
    align-items: center;
    gap: 8px;
    order: 1;              /* keep it on the first row */
  }

  .select{ padding: 5px 8px; font-size: 14px; border-radius: 9px; }
  .toggle.badge{ padding: 5px 8px; }

  /* tighten the board margins a bit so HUD isn't clipped */
  .board{ padding-top: 8px; }

  /* compact badges */
  .badge{
    padding: 6px 8px;
    border-radius: 10px;
    font-size: 14px;
    line-height: 1.1;
  }
  .score{display:flex;align-items:center;gap:8px;font-weight:700}
  .score small{color:var(--muted);font-weight:600}
  .dealer{display:inline-flex;align-items:center;gap:6px;padding:5px 9px;border-radius:999px;background:rgba(250,204,21,.12);border:1px solid rgba(250,204,21,.35);color:#facc15;font-weight:700}
  .right{display:flex;align-items:center;gap:10px}
  .select{appearance:none;background: var(--panel); border:1px solid rgba(255,255,255,.12); color:var(--text); padding:6px 10px; border-radius:10px}
  .toggle{display:inline-flex;align-items:center;gap:8px}

  /* Board */
  .board{
    position: relative;
    width:min(980px,100%); margin:0 auto;
    background: var(--panel); -webkit-backdrop-filter: var(--glass); backdrop-filter: var(--glass);
    border:1px solid rgba(255,255,255,.10);
    border-radius: var(--radius); padding:12px 10px;
    box-shadow: var(--card-shadow);
  }
  .bar{ text-align:center;font-weight:800;letter-spacing:.3px;margin:6px 0 4px;color:var(--accent-2) }

  .row{display:flex;justify-content:center;align-items:center;gap:12px;min-height:120px;margin:4px 0}
  #bot-hand, #player-hand{display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:nowrap} /* keep 5-in-row */

  .center-wrap{display:flex;flex-direction:column;align-items:center;gap:6px;margin:4px 0 8px}
  .trump-badge{
    display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
    background:rgba(56,189,248,.12);border:1px solid rgba(56,189,248,.35);
  }
  .trump-badge b{font-weight:800;color:var(--accent-2)}
  .trump-badge[data-suit="H"], .trump-badge[data-suit="D"]{ background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.45) }
  .trump-badge[data-suit="H"] b, .trump-badge[data-suit="D"] b{ color: var(--danger) }

  #trump-card-container{ position:relative; height:126px; box-shadow:none; background:transparent; }

  /* Stacked deck (3 layers) */
  #deck{
    position:absolute; top:6px; left:calc(50% - 28px); transform:translateX(-50%);
    width:var(--card-width); height:var(--card-height); background-image:var(--deck-img);
    background-size:contain; background-repeat:no-repeat; background-position:center;
    z-index:2; user-select:none; pointer-events:none; opacity:.98;
    transition: transform .12s ease; filter:none; box-shadow:none;
  }
  #deck::before, #deck::after{
    content:""; position:absolute; inset:0; border-radius:10px;
    background-image:var(--deck-img); background-size:contain; background-repeat:no-repeat; background-position:center;
    will-change: transform, opacity; filter:none;
  }
  #deck::before{ transform: translate(4px, 4px) rotate(.4deg); opacity:1 }
  #deck::after { transform: translate(8px, 8px) rotate(.8deg); opacity:1 }
  #deck.deck-pop{ transform: translateX(-50%) translateY(-6px) }
  #deck.deck-pop::before{ transform: translate(5px, 6px) rotate(.45deg) }
  #deck.deck-pop::after { transform: translate(9px,10px) rotate(.9deg)  }

  #trump-card{
    position:absolute;top:6px;left:calc(50% + 28px);transform:translateX(-50%);
    width:var(--card-width);height:var(--card-height);z-index:3;background:transparent;
    box-shadow:none; filter:none;
  }

  /* Cards */
  .card{
    width:var(--card-width);height:var(--card-height);border-radius:10px;box-shadow: var(--card-shadow);
    transition:.22s transform, .2s filter, .2s box-shadow;
    cursor:pointer; flex:0 0 auto;             /* don't stretch */
    background-color: rgba(0,0,0,.25);          /* dark placeholder to kill white flash */
    background-size: contain; background-repeat:no-repeat; background-position:center;
  }
  #player-hand .card:hover{transform:translateY(-7px) rotate(-.7deg)}
  #player-hand .card:active{transform:translateY(-2px) scale(.98)}
  .card.selected{transform:translateY(-12px) scale(1.02); box-shadow:0 0 0 3px rgba(245,158,11,.85), var(--card-shadow)}
  .card.to-discard{transform:translateY(12px); box-shadow:0 0 0 3px rgba(239,68,68,.9), var(--card-shadow)}
  .card.legal{box-shadow:0 0 0 3px rgba(56,189,248,.9), var(--card-shadow)}
  .card.illegal{filter:grayscale(.55) brightness(.85); cursor:not-allowed}

  #played-cards{display:flex;justify-content:center;gap:18px;min-height:120px;position:relative}
  .trick-out{ animation: trickCollect .35s ease forwards; }
  @keyframes trickCollect{ 0%{ transform:translate(0,0) scale(1); opacity:1 } 100%{ transform:translate(0,-12px) scale(.88); opacity:0 } }

  /* Controls */
  .controls{display:flex;justify-content:center;gap:10px;margin:8px 0 2px;flex-wrap:wrap}
  .btn-ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.15);padding:8px 12px;border-radius:12px;cursor:pointer}
  .btn-ghost:disabled{opacity:.45;cursor:not-allowed}
  .message{text-align:center;font-weight:800;color:var(--accent);margin:8px 0 0}

  /* Deal animation */
  @keyframes dealFromDeck {
    0%   { transform: translate(var(--fromX), var(--fromY)) scale(.96) rotate(var(--fromR,0deg)); opacity: 0 }
    100% { transform: translate(0,0) scale(1) rotate(0deg); opacity: 1 }
  }
  .deal-from-deck { animation: dealFromDeck .38s ease-out forwards }
  @keyframes flipReveal {
    0%   { transform: translateX(-50%) rotateY(90deg); opacity: 0 }
    50%  { transform: translateX(-50%) rotateY(10deg);  opacity: .85 }
    100% { transform: translateX(-50%) rotateY(0deg);   opacity: 1 }
  }
  .trump-flip { animation: flipReveal .35s ease-out forwards }

  /* ===== Responsive (keep 5-in-row by shrinking cards) ===== */

  /* Large phones - shrink cards a bit, keep one row */
  @media (max-width: 768px) {
    :root {
      --card-width: 70px;
      --card-height: 105px;
    }
    
    .row {
      gap: 8px;
      min-height: 110px;
    }
    
    #bot-hand, #player-hand {
      gap: 8px;
    }
    
    #trump-card-container {
      height: 112px;
    }
  }

  /* Medium phones */
  @media (max-width: 540px) {
    :root {
      --card-width: 62px;
      --card-height: 93px;
    }
    
    .row {
      gap: 6px;
      min-height: 100px;
    }
    
    #bot-hand, #player-hand {
      gap: 6px;
    }
    
    #trump-card-container {
      height: 100px;
    }
    
    /* allow wrap + keep things centered */
    .hud{
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px 8px;
    }
  }

  /* Small phones */
  @media (max-width: 450px) {
    :root {
      --card-width: 56px;
      --card-height: 84px;
    }
    
    .row {
      gap: 4px;
      min-height: 90px;
    }
    
    #bot-hand, #player-hand {
      gap: 4px;
    }
    
    #trump-card-container {
      height: 90px;
    }
    
    .hud { gap: 6px; }
    .badge { padding: 6px 8px; border-radius: 10px; }
    .dealer { padding: 3px 7px; font-size: 12px; }
    .bar { margin: 4px 0; }
    .board { padding: 10px 8px; }
    .controls { gap:8px; }
  }

  /* Very small phones (iPhone SE, etc) */
  @media (max-width: 390px) {
    :root {
      --card-width: 52px;
      --card-height: 78px;
    }
    
    .badge{ font-size: 13px; padding: 5px 7px; }
    .hud .score span{ font-size: 16px; }
    .select{ font-size: 13px; padding: 4px 7px; }
    .toggle.badge{ font-size: 13px; }
  }

  /* Ultra-tiny screens: allow wrap as last resort */
  @media (max-width: 340px) {
    :root {
      --card-width: 48px;
      --card-height: 72px;
    }
    
    #player-hand, #bot-hand { flex-wrap: wrap; gap: 8px; }
    #player-hand .card, #bot-hand .card { flex: 0 0 auto; }
  }

  /* Better centering for the deck vs trump on ALL sizes */
  #deck{
    left: calc(50% - var(--card-width) * 0.5);
    transform: translateX(-50%);
  }
  #trump-card{
    left: calc(50% + var(--card-width) * 0.5);
    transform: translateX(-50%);
  }

  /* Optional: iOS webview safe area (helps in Messenger/Safari) */
  @supports (padding: max(0px)){
    body{ padding-top: calc(16px + env(safe-area-inset-top, 0px)); }
  }
</style>
</head>
<body class="showing-welcome">
<div class="container">
  <!-- Welcome -->
  <div id="welcome-screen" class="welcome-screen">
    <div class="welcome-card">
      <h1 data-i18n="title">Muusig</h1>
      <p class="sub" data-i18n="subtitle">A slick, fast trick-taking duel. Swap, pick up trump, and pull the other player’s trumps!</p>
      <div class="card-preview">
        <div class="preview-card" style="background-image:url('cards/AS.png')"></div>
        <div class="preview-card" style="background-image:url('cards/KD.png')"></div>
        <div class="preview-card" style="background-image:url('cards/QH.png')"></div>
        <div class="preview-card" style="background-image:url('cards/JC.png')"></div>
      </div>
      <button id="start-game-btn" class="btn" data-i18n="start">Start Game</button>
    </div>
  </div>

  <!-- HUD -->
  <div class="hud">
    <div class="badge score">
      <small data-i18n="player">Player</small>
      <span id="player-score">15</span>
      <span id="player-dealer" class="dealer" style="display:none" data-i18n="dealer">Dealer</span>
    </div>
    <div class="badge">
      <span id="round-label">Round 1</span> • <span id="trick-label">Trick 1/5</span>
    </div>
    <div class="right">
      <div class="badge score">
        <small data-i18n="bot">Bot</small>
        <span id="bot-score">15</span>
        <span id="bot-dealer" class="dealer" style="display:none" data-i18n="dealer">Dealer</span>
      </div>
      <label class="toggle badge" style="gap:6px">
        <input id="sfx-toggle" type="checkbox" checked />
        <span data-i18n="sfx">SFX</span>
      </label>
      <select id="theme-select" class="select">
        <option value="dark" data-i18n="themeDark">Dark</option>
        <option value="light" data-i18n="themeLight">Light</option>
      </select>
      <select id="lang-select" class="select" title="Language">
        <option value="en">EN</option>
        <option value="mn">MN</option>
        <option value="ru">RU</option>
      </select>
    </div>
  </div>

  <!-- Board -->
  <div class="board">
    <div id="turn-banner" class="bar">Starting new game…</div>

    <div class="row" id="bot-area"><div id="bot-hand"></div></div>

    <div class="center-wrap">
      <div id="trump-badge" class="trump-badge">
        <span data-i18n="trump">Trump:</span><b id="trump-symbol">?</b>
        <span class="tricks">• <span data-i18n="player">Player</span> <span id="p-tricks">0</span> | <span data-i18n="bot">Bot</span> <span id="b-tricks">0</span></span>
      </div>
      <div id="trump-card-container">
        <div id="deck" class="card"></div>
        <div id="trump-card" class="card"></div>
      </div>
      <div id="played-cards"></div>
    </div>

    <div class="row" id="player-area"><div id="player-hand"></div></div>

    <div class="controls">
      <button id="swap-btn" class="btn-ghost" disabled data-i18n="swap">Swap</button>
      <button id="play-btn" class="btn-ghost" disabled data-i18n="directPlay">Direct Play</button>
      <button id="new-game-btn" class="btn-ghost" data-i18n="newGame">New Game</button>
    </div>
    <div id="message" class="message"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ---------- I18N ---------- */
  const i18n = {
    lang: localStorage.getItem('muusig_lang') || 'en',
    dict: {
      en: {
        title: "Muusig",
        subtitle: "A slick, fast trick-taking duel. Swap, pick up trump, and pull the other player’s trumps!",
        start: "Start Game",
        player: "Player",
        bot: "Bot",
        dealer: "Dealer",
        trump: "Trump:",
        sfx: "SFX",
        themeDark: "Dark",
        themeLight: "Light",
        swap: "Swap",
        directPlay: "Direct Play",
        newGame: "New Game",
        round: "Round {n}",
        trick: "Trick {n}/5",
        banner_starting: "Starting new game…",
        banner_swap_prompt: "Select 1–5 cards to swap, then press Swap",
        banner_pickup_prompt: "Select a card to discard, then click the trump card",
        banner_bot_leads: "Bot leads the first trick",
        banner_you_lead: "Your turn to lead",
        banner_bots_turn: "Bot's turn",
        banner_your_turn: "Your turn",
        banner_you_picked: "You picked up the trump {sym}",
        banner_bot_picked: "Bot picked up the trump {sym}",
        banner_direct_play: "Direct play — skipping swap.",
        banner_next_round: "Next round…",
        must_follow: "You must follow suit: {sym}.",
        must_trump: "You must play a trump ({sym}).",
        you_won: "🎉 You won the game!",
        bot_won: "Bot won the game."
      },
      mn: {
        title:"Муушиг", subtitle:"Идээд тат! Ар нь түүз. Муушигт тавтай морил!",
        start:"Тоглоом эхлүүлэх", player:"Тоглогч", bot:"Бот", dealer:"Тараагч",
        trump:"Хөзөр:", sfx:"Дуу", themeDark:"Бараан", themeLight:"Гэгээн",
        swap:"Солих", directPlay:"Шууд тоглох", newGame:"Шинэ тоглоом",
        round:"Гараа {n}", trick:"Гаралт {n}/5",
        banner_starting:"Шинэ тоглоом эхэлж байна…",
        banner_swap_prompt:"1–5 хөзөр сонгоод “Солих” товчийг дар",
        banner_pickup_prompt:"Хаях хөзрөө сонгоод газрын мод дээр дарна уу",
        banner_bot_leads:"Бот эхлэж гарна", banner_you_lead:"Таны ээлж",
        banner_bots_turn:"Ботын ээлж", banner_your_turn:"Таны ээлж",
        banner_you_picked:"Та хөзөр авлаа {sym}", banner_bot_picked:"Бот хөзөр авлаа {sym}",
        banner_next_round:"Дараагийн гараа…",
        must_follow:"Та өнгө дагах ёстой: {sym}.",
        must_trump:"Хөзөр тавих ёстой ({sym}).",
        you_won:"🎉 Та хожлоо!", bot_won:"Бот хожлоо."
      },
      ru: {
        title:"Муушик",
        subtitle:"Быстрая и ловкая дуэль со взятками. Меняйтесь картами, подбирайте козыри и тяните козыри соперника!",
        start:"Начать игру", player:"Игрок", bot:"Бот", dealer:"Дилер",
        trump:"Козырь:", sfx:"Звук", themeDark:"Тёмная", themeLight:"Светлая",
        swap:"Обмен", directPlay:"Играть немедленно", newGame:"Новая игра",
        round:"Раунд {n}", trick:"Трюки {n}/5",
        banner_starting:"Начинается новая игра…",
        banner_swap_prompt:"Выберите от 1 до 5 карт и нажмите «Обмен».",
        banner_pickup_prompt:"Выберите карту для сброса, затем нажмите на козырную карту.",
        banner_bot_leads:"Бот начинает игру", banner_you_lead:"Ваш ход",
        banner_bots_turn:"Ход бота", banner_your_turn:"Ваш ход",
        banner_you_picked:"Вы взяли козырь {sym}", banner_bot_picked:"Бот взял козырь {sym}",
        banner_next_round:"Следующий раунд…",
        must_follow:"Вы должны сходить в масть: {sym}.",
        must_trump:"Вы должны сыграть козырем ({sym}).",
        you_won:"🎉 Вы победили!", bot_won:"Бот победил."
      }
    }
  };
  function t(key, params={}){ const pack=i18n.dict[i18n.lang]||i18n.dict.en; let s=pack[key]??i18n.dict.en[key]??key; for (const[k,v] of Object.entries(params)) s=s.replaceAll(`{${k}}`,v); return s; }
  function applyStaticI18n(){ document.querySelectorAll('[data-i18n]').forEach(el=>{ el.textContent=t(el.getAttribute('data-i18n')); }); }
  function setLang(lang){ i18n.lang=lang; localStorage.setItem('muusig_lang',lang); applyStaticI18n(); updateHeaders(); banner(t('banner_starting')); }

  /* ---------- CONSTANTS / STATE ---------- */
  const RANKS = ['7','8','9','10','J','Q','K','A'];
  const RANK_VALUE = Object.fromEntries(RANKS.map((r,i)=>[r,i]));
  const SFX = {
    enabled: true,
    deal : new AudioSafe('sounds/deal.mp3'),
    shuffle:new AudioSafe('sounds/shuffle.mp3'),
    flip : new AudioSafe('sounds/flip.mp3'),
    click: new AudioSafe('sounds/click.mp3'),
    score: new AudioSafe('sounds/score.mp3'),
    play : new AudioSafe('sounds/play.mp3')
  };

  const state = {
    deck: [], playerHand: [], botHand: [],
    trumpCard: null, trumpSuit: null,
    dealer: null, currentPlayer: null,
    playerScore: 15, botScore: 15,
    round: 1, tricksPlayed: 0,
    selectedCards: [], currentTrick: [],
    leadingSuit: null, swapPhase: false, pickupPhase: false,
    cardToDiscard: null, gameOver: false,
    playerTricksThisRound: 0, botTricksThisRound: 0,
    lastTrickWinner: null
  };

  const el = {
    welcome: document.getElementById('welcome-screen'),
    start: document.getElementById('start-game-btn'),
    theme: document.getElementById('theme-select'),
    lang:  document.getElementById('lang-select'),
    sfxToggle: document.getElementById('sfx-toggle'),

    playerHand: document.getElementById('player-hand'),
    botHand: document.getElementById('bot-hand'),
    played: document.getElementById('played-cards'),
    trumpCard: document.getElementById('trump-card'),
    trumpBadge: document.getElementById('trump-badge'),
    trumpSym: document.getElementById('trump-symbol'),
    deck: document.getElementById('deck'),

    message: document.getElementById('message'),
    banner: document.getElementById('turn-banner'),

    swap: document.getElementById('swap-btn'),
    play: document.getElementById('play-btn'),
    newGame: document.getElementById('new-game-btn'),

    pScore: document.getElementById('player-score'),
    bScore: document.getElementById('bot-score'),
    pDealer: document.getElementById('player-dealer'),
    bDealer: document.getElementById('bot-dealer'),
    pTricks: document.getElementById('p-tricks'),
    bTricks: document.getElementById('b-tricks'),
    roundLabel: document.getElementById('round-label'),
    trickLabel: document.getElementById('trick-label')
  };

  function AudioSafe(src){
    const a = new Audio(); a.src = src; a.preload = 'auto';
    a.playSafe = () => {
      if (!SFX.enabled) return;
      const p = a.cloneNode(); p.volume = 0.85; p.play().catch(()=>{});
    };
    return a;
  }

  function msg(s){ el.message.textContent=s; }
  function banner(s){ el.banner.textContent=s; }
  function sym(s){ return ({S:'♠',H:'♥',D:'♦',C:'♣'})[s]||s; }
  function suitName(s){ return ({S:'Spades',H:'Hearts',D:'Diamonds',C:'Clubs'})[s]||s; }
  function createCard(c){ const d=document.createElement('div'); d.className='card'; if(c) d.style.backgroundImage=`url('cards/${c.code}.png')`; return d; }

  function animateScore(elm, to){
    const from = +elm.textContent || 0;
    if (from === to) return;
    const diff = to - from;
    const steps = Math.min(10, Math.abs(diff));
    let cur = 0;
    const tick = () => {
      cur++; elm.textContent = Math.round(from + diff * (cur/steps));
      if (cur < steps){ requestAnimationFrame(tick); }
      else { elm.classList.add('score-glow'); setTimeout(()=>elm.classList.remove('score-glow'), 650); SFX.score.playSafe(); }
    };
    requestAnimationFrame(tick);
  }
  function updateScores(){ animateScore(el.pScore, state.playerScore); animateScore(el.bScore, state.botScore); }
  function updateHeaders(){
    el.roundLabel.textContent = t('round', {n: state.round});
    el.trickLabel.textContent = t('trick', {n: Math.min(state.tricksPlayed+1,5)});
    el.pTricks.textContent = state.playerTricksThisRound;
    el.bTricks.textContent = state.botTricksThisRound;
  }

  function renderHands(highlightLegal=false){
    el.playerHand.innerHTML = '';
    state.playerHand.forEach((card)=>{
      const d=createCard(card);
      if (highlightLegal){
        const legal = playerMoveIsLegalCard(card);
        d.classList.add(legal ? 'legal' : 'illegal');
      }
      el.playerHand.appendChild(d);
    });

    el.botHand.innerHTML = '';
    state.botHand.forEach(()=> {
      const d=document.createElement('div');
      d.className='card';
      d.style.backgroundImage='var(--deck-img)';
      el.botHand.appendChild(d);
    });
  }
  function renderTrick(){ el.played.innerHTML=''; state.currentTrick.forEach(p=> el.played.appendChild(createCard(p.card))); }

  function resetDeckAndTrumpUI(){
    el.deck.style.transform = 'translateX(-50%)';
    el.trumpCard.style.display = 'block';
    el.trumpCard.style.filter = 'none';
  }
  function hideTrumpCard(){ el.trumpCard.innerHTML=''; el.trumpCard.style.backgroundImage='none'; el.trumpCard.style.display='none'; }
  function revealTrump(){
    el.trumpCard.innerHTML=''; el.trumpCard.appendChild(createCard(state.trumpCard));
    el.trumpSym.textContent = sym(state.trumpSuit);
    el.trumpBadge.setAttribute('data-suit', state.trumpSuit);
    el.trumpCard.style.display='block';
    el.trumpCard.classList.remove('trump-flip'); void el.trumpCard.offsetWidth; el.trumpCard.classList.add('trump-flip');
    SFX.flip.playSafe();
  }

  function indexOfWeakest(hand, filter=()=>true){
    const order={'7':0,'8':1,'9':2,'10':3,'J':4,'Q':5,'K':6,'A':7};
    let idx=-1, best=1e9;
    hand.forEach((c,i)=>{ if(!filter(c))return; const v=order[c.rank]+(c.suit===state.trumpSuit?10:0); if(v<best){best=v; idx=i;} });
    return idx;
  }
  function indexOfHighestTrump(hand){
    const order={'7':0,'8':1,'9':2,'10':3,'J':4,'Q':5,'K':6,'A':7}; let idx=-1, best=-1;
    hand.forEach((c,i)=>{ if(c.suit!==state.trumpSuit)return; if(order[c.rank]>best){best=order[c.rank]; idx=i;} }); return idx;
  }
  function indexOfLowestTrump(hand){ return indexOfWeakest(hand, c=>c.suit===state.trumpSuit); }
  function indexOfBestFollow(hand, lead){
    let idx=-1, best=1e9;
    hand.forEach((c,i)=>{ if(c.suit!==lead.suit)return; if(RANK_VALUE[c.rank]>RANK_VALUE[lead.rank] && RANK_VALUE[c.rank]<best){best=RANK_VALUE[c.rank]; idx=i;} });
    return (idx!==-1)?idx:indexOfWeakest(hand, c=>c.suit===lead.suit);
  }
  function hasVeryStrongTrumps(hand){ return hand.filter(c=>c.suit===state.trumpSuit && ['A','K','Q'].includes(c.rank)).length>=2; }
  function indexOfLowestWinningTrump(hand, lead){
    if (lead.suit !== state.trumpSuit) return -1; let idx=-1, best=1e9;
    hand.forEach((c,i)=>{ if(c.suit!==state.trumpSuit)return; if(RANK_VALUE[c.rank]>RANK_VALUE[lead.rank] && RANK_VALUE[c.rank]<best){best=RANK_VALUE[c.rank]; idx=i;} });
    return idx;
  }
  function indexOfSpecific(hand, rank, suit){ for(let i=0;i<hand.length;i++) if(hand[i].rank===rank && hand[i].suit===suit) return i; return -1; }

  /* ----- THEME / SFX / START / LANG ----- */
  document.getElementById('theme-select').addEventListener('change', (e)=>{ document.body.classList.toggle('theme-light', e.target.value==='light'); });
  document.getElementById('sfx-toggle').addEventListener('change', e=>{ SFX.enabled = e.target.checked; });
  document.getElementById('start-game-btn').addEventListener('click', ()=>{
    document.body.classList.remove('showing-welcome');
    SFX.shuffle.playSafe();
    document.getElementById('welcome-screen').classList.add('hidden');
    setTimeout(()=>{ document.getElementById('welcome-screen').style.display='none'; startNewGame(); }, 620);
  });
  document.getElementById('new-game-btn').addEventListener('click', ()=>{ location.reload(); });
  document.getElementById('lang-select').addEventListener('change', (e)=> setLang(e.target.value));

  // Direct Play
  document.getElementById('play-btn').addEventListener('click', () => {
    if (!state.swapPhase || state.pickupPhase || state.gameOver) return;
    state.selectedCards = [];
    [...el.playerHand.children].forEach(c => c.classList.remove('selected', 'to-discard'));
    el.swap.disabled = true; el.play.disabled = true;
    state.swapPhase = false;
    if (state.dealer === 'bot') botPickup(startTricks);
    else startPickup();
  });

  (function initLang(){
    const saved = i18n.lang; document.getElementById('lang-select').value = saved;
    applyStaticI18n(); banner(t('banner_starting'));
  })();

  /* ---------- GAME FLOW ---------- */
  function startNewGame(){
    Object.assign(state, {
      deck:[], playerHand:[], botHand:[],
      trumpCard:null, trumpSuit:null,
      dealer:null, currentPlayer:null,
      playerScore:15, botScore:15,
      round:1, tricksPlayed:0, selectedCards:[],
      currentTrick:[], leadingSuit:null,
      swapPhase:false, pickupPhase:false,
      cardToDiscard:null, gameOver:false,
      playerTricksThisRound:0, botTricksThisRound:0,
      lastTrickWinner:null
    });
    updateScores(); updateHeaders(); banner(t('banner_starting')); startRound();
  }

  function startRound(){
    state.tricksPlayed=0; state.playerTricksThisRound=0; state.botTricksThisRound=0;
    state.currentTrick=[]; state.leadingSuit=null; state.selectedCards=[]; state.cardToDiscard=null;
    state.pickupPhase=false; state.lastTrickWinner=null; resetDeckAndTrumpUI();

    el.play.disabled = true;

    state.dealer = (state.round===1) ? (Math.random()<.5?'player':'bot') : (state.dealer==='player'?'bot':'player');
    document.getElementById('player-dealer').style.display = state.dealer==='player' ? 'inline-flex' : 'none';
    document.getElementById('bot-dealer').style.display = state.dealer==='bot' ? 'inline-flex' : 'none';

    generateDeck(); shuffle(); deal5AnimatedFromDeck(() => {
      state.trumpCard = state.deck.pop();
      state.trumpSuit = state.trumpCard.suit;
      revealTrump();
      updateHeaders(); updateScores(); msg('');

      if (state.dealer==='player'){
        setTimeout(()=>{
          botSwap(); state.swapPhase = true;
          msg(t('banner_swap_prompt')); el.swap.disabled = true; el.play.disabled = false;
        }, 300);
      } else {
        state.swapPhase = true; msg(t('banner_swap_prompt'));
        el.swap.disabled = true; el.play.disabled = false;
      }
    });
  }

  function generateDeck(){ const suits=['S','H','D','C']; state.deck=[]; suits.forEach(s=>RANKS.forEach(r=>state.deck.push({rank:r,suit:s,code:r+s}))); }
  function shuffle(){ for(let i=state.deck.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [state.deck[i],state.deck[j]]=[state.deck[j],state.deck[i]]; } }

  function deal5AnimatedFromDeck(done){
    state.playerHand=[]; state.botHand=[];
    el.playerHand.innerHTML=''; el.botHand.innerHTML='';
    const botElems=[], playerElems=[];
    for (let i=0;i<5;i++){
      const b=document.createElement('div'); b.className='card'; b.style.backgroundImage='var(--deck-img)'; b.style.opacity='0';
      el.botHand.appendChild(b); botElems.push(b);
      const p=document.createElement('div'); p.className='card'; p.style.opacity='0';
      el.playerHand.appendChild(p); playerElems.push(p);
    }
    const deckRect = el.deck.getBoundingClientRect();
    const launchX = deckRect.left + deckRect.width * 0.5;
    const launchY = deckRect.top  + deckRect.height * 0.22;

    function setFromVars(targetEl){
      const r = targetEl.getBoundingClientRect();
      const targetX = r.left + r.width/2;
      const targetY = r.top  + r.height/2;
      const dx = launchX - targetX;
      const dy = launchY - targetY;
      const rand = (Math.random()*1.6 - 0.8).toFixed(2) + 'deg';
      targetEl.style.setProperty('--fromX', dx + 'px');
      targetEl.style.setProperty('--fromY', dy + 'px');
      targetEl.style.setProperty('--fromR', rand);
    }
    function bumpStack(){ el.deck.classList.add('deck-pop'); setTimeout(()=> el.deck.classList.remove('deck-pop'), 120); }

    let step=0;
    function dealNext(){
      if (step>=5){ setTimeout(()=>{ if (typeof done==='function') done(); }, 160); return; }

      const pCard = state.deck.pop(); state.playerHand.push(pCard);
      playerElems[step].style.backgroundImage = `url('cards/${pCard.code}.png')`;
      setFromVars(playerElems[step]); bumpStack(); SFX.deal.playSafe();
      playerElems[step].classList.add('deal-from-deck'); playerElems[step].style.opacity='1';

      const thisStep=step;
      const bCard = state.deck.pop(); state.botHand.push(bCard);
      setTimeout(()=>{
        setFromVars(botElems[thisStep]); bumpStack(); SFX.deal.playSafe();
        botElems[thisStep].classList.add('deal-from-deck'); botElems[thisStep].style.opacity='1';
      }, 120);

      step++; setTimeout(dealNext, 250);
    }
    dealNext();
  }

  /* ----- SWAP / PICKUP ----- */
  el.playerHand.addEventListener('click', (e)=>{
    if (state.gameOver) return;
    const cardEl=e.target.closest('.card'); if(!cardEl) return;
    const index=[...el.playerHand.children].indexOf(cardEl);
    SFX.click.playSafe();

    if (state.swapPhase){ toggleSwap(index); el.swap.disabled = state.selectedCards.length===0; }
    else if (state.pickupPhase){ selectDiscard(index); }
    else if (state.currentPlayer==='player'){ playCard(index); }
  });
  el.trumpCard.addEventListener('click', ()=>{ if (state.pickupPhase && state.cardToDiscard!==null){ SFX.flip.playSafe(); pickupTrump(); } });
  el.swap.addEventListener('click', ()=>{ if (state.swapPhase && state.selectedCards.length>0 && !state.pickupPhase) doSwap(); });

  function toggleSwap(i){
    const cardEl=el.playerHand.children[i];
    const at=state.selectedCards.indexOf(i);
    if(at===-1){ state.selectedCards.push(i); cardEl.classList.add('selected'); }
    else { state.selectedCards.splice(at,1); cardEl.classList.remove('selected'); }
  }
  function selectDiscard(i){
    [...el.playerHand.children].forEach(c=>c.classList.remove('to-discard'));
    state.cardToDiscard=i; el.playerHand.children[i].classList.add('to-discard');
    banner(t('banner_pickup_prompt'));
  }
  function doSwap(){
    state.selectedCards.sort((a,b)=>b-a);
    const out=[]; state.selectedCards.forEach(i=> out.push(state.playerHand.splice(i,1)[0]));
    for(let i=0;i<out.length;i++) state.playerHand.push(state.deck.pop());
    state.selectedCards=[]; state.swapPhase=false; renderHands();
    el.play.disabled = true;
    if (state.dealer==='player'){ startPickup(); } else { botSwap(); botPickup(()=>startTricks()); }
  }
  function startPickup(){ state.pickupPhase=true; el.play.disabled=true; banner(t('banner_pickup_prompt')); }
  function botSwap(){
    const nonTrumpsIdx = state.botHand
      .map((c,i)=>({i,val:RANK_VALUE[c.rank] + (c.suit===state.trumpSuit?10:0)}))
      .filter(o=>state.botHand[o.i].suit!==state.trumpSuit)
      .sort((a,b)=>a.val-b.val)
      .map(o=>o.i);
    const count=Math.floor(Math.random()*5)+1;
    const toSwap=(nonTrumpsIdx.length?nonTrumpsIdx:state.botHand.map((_,i)=>i)).slice(0,count).sort((a,b)=>b-a);
    toSwap.forEach(i=>{ state.botHand.splice(i,1,state.deck.pop()); });
  }
  function botPickup(done){
    el.deck.style.transform='translateX(-150%)';
    setTimeout(()=>{
      const idxNonTrump = indexOfWeakest(state.botHand, c=>c.suit!==state.trumpSuit);
      const idx = (idxNonTrump!==-1)? idxNonTrump : indexOfWeakest(state.botHand);
      const discarded = state.botHand.splice(idx,1)[0];
      state.botHand.push(state.trumpCard);
      hideTrumpCard();
      state.deck.unshift(discarded);
      banner(t('banner_bot_picked', {sym: sym(state.trumpSuit)}));
      if (typeof done==='function') done();
    }, 420);
  }
  function pickupTrump(){
    el.deck.style.transform='translateX(-150%)';
    setTimeout(()=>{
      const discarded = state.playerHand.splice(state.cardToDiscard, 1)[0];
      state.playerHand.push(state.trumpCard);
      hideTrumpCard();
      state.deck.unshift(discarded);
      state.pickupPhase=false; state.cardToDiscard=null;
      renderHands();
      banner(t('banner_you_picked', {sym: sym(state.trumpSuit)}));
      startTricks();
    }, 400);
  }

  /* ----- TRICKS ----- */
  function startTricks(){
    el.play.disabled = true;
    state.currentTrick=[]; state.leadingSuit=null;
    state.currentPlayer = (state.dealer==='player') ? 'bot' : 'player';
    banner(state.currentPlayer==='bot' ? t('banner_bot_leads') : t('banner_you_lead'));
    renderHands(state.currentPlayer==='player');
    if (state.currentPlayer==='bot') setTimeout(()=>botPlay(), 600);
  }

  function playerMoveIsLegalCard(card){
    if (state.currentTrick.length===0) return true;
    const lead=state.currentTrick[0].card;
    const canFollow=state.playerHand.some(c=>c.suit===lead.suit);
    if (canFollow) return card.suit===lead.suit;
    const hasTrump=state.playerHand.some(c=>c.suit===state.trumpSuit);
    if (hasTrump) return card.suit===state.trumpSuit;
    return true;
  }

  function playCard(i){
    if (state.currentPlayer!=='player') return;
    const card=state.playerHand[i];
    if (!playerMoveIsLegalCard(card)){
      const lead = state.currentTrick[0]?.card;
      if (lead){
        const canFollow=state.playerHand.some(c=>c.suit===lead.suit);
        if (canFollow && card.suit!==lead.suit){ msg(`You must follow suit: ${suitName(lead.suit)}.`); return; }
        const hasTrump=state.playerHand.some(c=>c.suit===state.trumpSuit);
        if (!canFollow && hasTrump && card.suit!==state.trumpSuit){ msg(`You must play a trump (${sym(state.trumpSuit)}).`); return; }
      }
    }
    msg('');
    state.playerHand.splice(i,1);
    state.currentTrick.push({card, player:'player'});
    renderHands(false); renderTrick();

    if (state.currentTrick.length===1){
      state.leadingSuit=card.suit;
      state.currentPlayer='bot';
      setTimeout(()=>{ banner(t('banner_bots_turn')); botPlay(); }, 420);
    } else {
      setTimeout(resolveTrick, 420);
    }
  }

  function botPlay(){
    if (state.currentPlayer!=='bot') return;
    let idx=-1;
    if (state.currentTrick.length===0){
      const aIdx = indexOfSpecific(state.botHand,'A',state.trumpSuit);
      if (aIdx!==-1) idx=aIdx;
      else{
        const kIdx = indexOfSpecific(state.botHand,'K',state.trumpSuit);
        if (state.lastTrickWinner==='bot' && kIdx!==-1) idx=kIdx;
        else{
          const hasNonTrump = state.botHand.some(c=>c.suit!==state.trumpSuit);
          if (hasNonTrump) idx=indexOfWeakest(state.botHand, c=>c.suit!==state.trumpSuit);
          else idx = hasVeryStrongTrumps(state.botHand) ? indexOfHighestTrump(state.botHand) : indexOfLowestTrump(state.botHand);
        }
      }
    } else {
      const lead = state.currentTrick[0].card;
      const canFollow = state.botHand.some(c=>c.suit===lead.suit);
      if (canFollow) idx=indexOfBestFollow(state.botHand, lead);
      else{
        const hasTrump = state.botHand.some(c=>c.suit===state.trumpSuit);
        if (hasTrump){
          const win = indexOfLowestWinningTrump(state.botHand, lead);
          idx = (win!==-1)? win : indexOfLowestTrump(state.botHand);
        } else idx = indexOfWeakest(state.botHand);
      }
    }

    if (idx<0) idx=0;
    const card=state.botHand.splice(idx,1)[0];
    state.currentTrick.push({card, player:'bot'});
    renderHands(false); renderTrick();

    if (state.currentTrick.length===2) setTimeout(resolveTrick, 400);
    else { state.currentPlayer='player'; banner(t('banner_your_turn')); renderHands(true); }
  }

  function determineWinner(){
    const [aPlay,bPlay] = state.currentTrick;
    const a=aPlay.card, b=bPlay.card;
    if (a.suit===b.suit) return (RANK_VALUE[a.rank]>RANK_VALUE[b.rank]) ? aPlay.player : bPlay.player;
    if (b.suit===state.trumpSuit) return bPlay.player;
    if (a.suit===state.trumpSuit) return aPlay.player;
    return aPlay.player;
  }

  function resolveTrick(){
    [...document.getElementById('played-cards').children].forEach(child => child.classList.add('trick-out'));
    const winner = determineWinner();
    state.lastTrickWinner = winner;
    if (winner==='player') state.playerTricksThisRound++; else state.botTricksThisRound++;
    state.tricksPlayed++; updateHeaders();

    setTimeout(()=>{
      state.currentTrick=[]; renderTrick();
      if (state.tricksPlayed>=5){ scoreRound(); return; }
      state.currentPlayer = winner;
      if (winner==='bot'){ banner(`${t('banner_bot_leads')}`); setTimeout(()=>botPlay(), 600); }
      else { banner(t('banner_you_lead')); renderHands(true); }
    }, 360);
  }

  function scoreRound(){
    const p=state.playerTricksThisRound, b=state.botTricksThisRound;
    let pDelta = (p===5) ? -5 : -p;
    let bDelta = (b===5) ? -5 : -b;
    if (p===0) pDelta = +5;
    if (b===0) bDelta = +5;

    state.playerScore = Math.max(0, state.playerScore + pDelta);
    state.botScore    = Math.max(0, state.botScore + bDelta);
    updateScores();

    if (state.playerScore<=0 || state.botScore<=0){
      banner(state.playerScore<=0 ? t('you_won') : t('bot_won'));
      state.gameOver=true; return;
    }

    resetDeckAndTrumpUI();
    state.round++; banner(t('banner_next_round')); setTimeout(startRound, 900);
  }

  applyStaticI18n();
});
</script>
</body>
</html>
